<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</title>
  <link rel="stylesheet" href="dashboard.css">
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
</head>
<body>
  <div class="container">
    <h1>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
    <a href="index.html" class="btn-history">‚ùÆ ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>

    <div class="controls">
      <label for="summaryDate">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
      <input type="date" id="summaryDate">

      <label for="classSelect">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</label>
      <select id="classSelect">
        <option value="All">‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô</option>
        <option value="‡∏°.1/1">‡∏°.1/1</option>
        <option value="‡∏°.1/2">‡∏°.1/2</option>
        <option value="‡∏°.2/1">‡∏°.2/1</option>
        <option value="‡∏°.2/2">‡∏°.2/2</option>
        <option value="‡∏°.2/3">‡∏°.2/3</option>
        <option value="‡∏°.3/1">‡∏°.3/1</option>
        <option value="‡∏°.3/2">‡∏°.3/2</option>
        <option value="‡∏°.3/3">‡∏°.3/3</option>
        <option value="‡∏°.4/1">‡∏°.4/1</option>
        <option value="‡∏°.4/2">‡∏°.4/2</option>
        <option value="‡∏°.5/1">‡∏°.5/1</option>
        <option value="‡∏°.5/2">‡∏°.5/2</option>
        <option value="‡∏°.6/1">‡∏°.6/1</option>
        <option value="‡∏°.6/2">‡∏°.6/2</option>
        <option value="‡∏°.6/3">‡∏°.6/3</option>
      </select>
    </div>

    <div id="errorMessage" class="error-message" style="display: none;"></div>
    <div id="loadingMessage" class="loading-message">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>

    <!-- New Summary Cards Section -->
    <div class="summary-cards">
        <div class="summary-card status-present">
            <h3>‡∏°‡∏≤</h3>
            <p id="countPresent" class="count">0</p>
        </div>
        <div class="summary-card status-absent">
            <h3>‡∏Ç‡∏≤‡∏î</h3>
            <p id="countAbsent" class="count">0</p>
        </div>
        <div class="summary-card status-leave">
            <h3>‡∏•‡∏≤</h3>
            <p id="countLeave" class="count">0</p>
        </div>
        <div class="summary-card status-late">
            <h3>‡∏°‡∏≤‡∏™‡∏≤‡∏¢</h3>
            <p id="countLate" class="count">0</p>
        </div>
    </div>

    <!-- Chart Section -->
    <div class="chart-section">
        <div class="chart-card">
            <canvas id="doughnutChartCanvas"></canvas>
        </div>
        <div class="chart-card">
            <canvas id="lineChartCanvas"></canvas>
        </div>
    </div>

  </div>

  <script>
    // *** ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ Web app URL ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Apps Script Deploy ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏£‡∏¥‡∏á‡πÜ ***
    // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbye52tppYF_KiMXxdj23RoDlU7bTtE5xxz_912bOxbwu-jLvJq1iuveWdslC2O1_HT3/exec';
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxBoF02Gn_1ZhWTLAoJ23QRCDnhJmseEKOsvty0yLUisisx1ZmCQlkGXn1qv3VRL5cd/exec'; 
    const summaryDateInput = document.getElementById('summaryDate');
    const classSelect = document.getElementById('classSelect');
    const errorMessage = document.getElementById('errorMessage');
    const loadingMessage = document.getElementById('loadingMessage');

    let myLineChart;
    let myDoughnutChart;

    // Set today's date as default
    const today = new Date();
    summaryDateInput.value = today.toISOString().split('T')[0];

    async function fetchAndDisplayDailySummary() {
      loadingMessage.style.display = 'block';
      errorMessage.style.display = 'none';

      const selectedDate = summaryDateInput.value;
      const selectedClass = classSelect.value;

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ WEB_APP_URL ‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß
      if (WEB_APP_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE' || !WEB_APP_URL || WEB_APP_URL.includes('YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE')) {
          errorMessage.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ WEB_APP_URL ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå HTML ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
          errorMessage.style.display = 'block';
          loadingMessage.style.display = 'none';
          return;
      }

      try {
        const response = await fetch(`${WEB_APP_URL}?action=getDailySummary&date=${selectedDate}&class=${selectedClass}`);
        
        if (!response.ok) {
            // ‡∏ñ‡πâ‡∏≤ Response ‡πÑ‡∏°‡πà OK (‡πÄ‡∏ä‡πà‡∏ô 404, 500) ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Error ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á
            const errorText = await response.text();
            throw new Error(`HTTP error! status: ${response.status}. Response: ${errorText}`);
        }
        
        let data;
        try {
            // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÅ‡∏õ‡∏•‡∏á Response ‡πÄ‡∏õ‡πá‡∏ô JSON
            data = await response.json();
        } catch (jsonParseError) {
            // ‡∏ñ‡πâ‡∏≤ JSON Parsing ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏¥‡∏ö‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á
            const rawResponseText = await response.text();
            throw new Error(`JSON parsing failed: ${jsonParseError.message}. Raw response: "${rawResponseText}"`);
        }

        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà Apps Script ‡∏™‡πà‡∏á Object ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô Error ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô {status: 'error', message: '...'})
        if (data && (data.status === 'error' || data.error)) {
            errorMessage.textContent = data.message || data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet';
            errorMessage.style.display = 'block';
            // Clear summary cards and charts
            document.getElementById('countPresent').textContent = '0';
            document.getElementById('countAbsent').textContent = '0';
            document.getElementById('countLeave').textContent = '0';
            document.getElementById('countLate').textContent = '0';
            if (myLineChart) myLineChart.destroy();
            if (myDoughnutChart) myDoughnutChart.destroy();
            return;
        }

        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Array (‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ)
        if (!Array.isArray(data)) {
            errorMessage.textContent = '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å Google Sheet ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á Array ‡πÅ‡∏ï‡πà‡πÑ‡∏î‡πâ ' + typeof data + ') ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Apps Script';
            errorMessage.style.display = 'block';
            // Clear summary cards and charts
            document.getElementById('countPresent').textContent = '0';
            document.getElementById('countAbsent').textContent = '0';
            document.getElementById('countLeave').textContent = '0';
            document.getElementById('countLate').textContent = '0';
            if (myLineChart) myLineChart.destroy();
            if (myDoughnutChart) myDoughnutChart.destroy();
            console.error('Received data is not an array:', data);
            return;
        }

        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤ data ‡πÄ‡∏õ‡πá‡∏ô Array ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
        let filteredData = data; 

        // Destroy previous charts before drawing new ones
        if (myLineChart) myLineChart.destroy();
        if (myDoughnutChart) myDoughnutChart.destroy();
        
        // Calculate total counts for summary cards
        let totalPresent = 0;
        let totalAbsent = 0;
        let totalLeave = 0;
        let totalLate = 0;

        filteredData.forEach(item => { 
            totalPresent += item['‡∏°‡∏≤'] || 0; // ‡πÉ‡∏ä‡πâ bracket notation ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ key ‡∏°‡∏µ emoji/‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á
            totalAbsent += item['‡∏Ç‡∏≤‡∏î'] || 0;
            totalLeave += item['‡∏•‡∏≤'] || 0;
            totalLate += item['‡∏°‡∏≤‡∏™‡∏≤‡∏¢'] || 0;
        });

        // Update summary cards
        document.getElementById('countPresent').textContent = totalPresent;
        document.getElementById('countAbsent').textContent = totalAbsent;
        document.getElementById('countLeave').textContent = totalLeave;
        document.getElementById('countLate').textContent = totalLate;


        // Prepare data for Line Chart
        const lineChartCanvas = document.getElementById('lineChartCanvas').getContext('2d');
        const labelsForLineChart = filteredData.map(item => item.class); 
        const presentData = filteredData.map(item => item['‡∏°‡∏≤']);
        const absentData = filteredData.map(item => item['‡∏Ç‡∏≤‡∏î']);
        const leaveData = filteredData.map(item => item['‡∏•‡∏≤']);
        const lateData = filteredData.map(item => item['‡∏°‡∏≤‡∏™‡∏≤‡∏¢']);

        const lineChartData = {
            labels: labelsForLineChart,
            datasets: [
                {
                    label: '‡∏°‡∏≤',
                    data: presentData,
                    borderColor: '#4CAF50', // Green
                    backgroundColor: 'rgba(76, 175, 80, 0.2)',
                    fill: true,
                    tension: 0.3
                },
                {
                    label: '‡∏Ç‡∏≤‡∏î',
                    data: absentData,
                    borderColor: '#F44336', // Red
                    backgroundColor: 'rgba(244, 67, 54, 0.2)',
                    fill: true,
                    tension: 0.3
                },
                {
                    label: '‡∏•‡∏≤',
                    data: leaveData,
                    borderColor: '#FFEB3B', // Yellow
                    backgroundColor: 'rgba(255, 235, 59, 0.2)',
                    fill: true,
                    tension: 0.3
                },
                {
                    label: '‡∏°‡∏≤‡∏™‡∏≤‡∏¢',
                    data: lateData,
                    borderColor: '#2196F3', // Blue
                    backgroundColor: 'rgba(33, 150, 243, 0.2)',
                    fill: true,
                    tension: 0.3
                }
            ]
        };

        const lineChartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: `‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${selectedDate} (‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)`
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return `‡∏ä‡∏±‡πâ‡∏ô: ${context[0].label}`;
                        },
                        label: function(context) {
                            return `${context.dataset.label}: ${context.raw} ‡∏Ñ‡∏ô`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: '‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'
                    }
                }
            }
        };

        myLineChart = new Chart(lineChartCanvas, {
            type: 'line',
            data: lineChartData,
            options: lineChartOptions
        });


        // Prepare data for Doughnut Chart (always uses total counts for selected date/class)
        const doughnutChartCanvas = document.getElementById('doughnutChartCanvas').getContext('2d');
        const doughnutData = {
            labels: ['‡∏°‡∏≤', '‡∏Ç‡∏≤‡∏î', '‡∏•‡∏≤', '‡∏°‡∏≤‡∏™‡∏≤‡∏¢'],
            datasets: [{
                data: [totalPresent, totalAbsent, totalLeave, totalLate], // Use total counts from filtered data
                backgroundColor: ['#4CAF50', '#F44336', '#FFEB3B', '#2196F3'],
                hoverOffset: 4
            }]
        };

        const doughnutOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: `‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${selectedDate} ${selectedClass === 'All' ? '(‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô)' : `(‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° ${selectedClass})`}`
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed !== null) {
                                label += context.raw + ' ‡∏Ñ‡∏ô';
                            }
                            return label;
                        }
                    }
                }
            }
        };

        myDoughnutChart = new Chart(doughnutChartCanvas, {
            type: 'doughnut',
            data: doughnutData,
            options: doughnutOptions
        });

      } catch (error) {
        console.error('Error fetching daily summary:', error);
        errorMessage.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Google Sheet: ' + error.message;
        errorMessage.style.display = 'block';
         // Clear summary cards and charts on error
        document.getElementById('countPresent').textContent = '0';
        document.getElementById('countAbsent').textContent = '0';
        document.getElementById('countLeave').textContent = '0';
        document.getElementById('countLate').textContent = '0';
        if (myLineChart) myLineChart.destroy();
        if (myDoughnutChart) myDoughnutChart.destroy();
      } finally {
        loadingMessage.style.display = 'none';
      }
    }
    
    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà
    summaryDateInput.addEventListener('change', fetchAndDisplayDailySummary);
    classSelect.addEventListener('change', fetchAndDisplayDailySummary);

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô)
    document.addEventListener('DOMContentLoaded', fetchAndDisplayDailySummary);
  </script>
</body>
</html>
